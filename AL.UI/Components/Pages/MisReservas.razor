@page "/misreservas"
@using AL.UI.Components
@rendermode InteractiveServer
@inject NavigationManager NavigationManager
@inject CancelarReservaCasoDeUso cancelarReservaUseCase
@inject ReservaConsultaTodosPorUsuario ReservaConsultaTodosPorUsuario
@inject AlojamientoPuntuar AlojamientoPuntuar
@inject IServicioSesion ServicioSesion
@inject IServicioChat ServicioChat
@inject IReservasRepositorio ReservasRepositorio
@inject IUsuarioRepositorio UsuarioRepositorio
@inject ITarjetaRepositorio TarjetaRepositorio

<h3>Datos personales</h3>
@if (_usuario == null)
{
    <p><em>Cargando...</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Fecha de Nacimiento</th>
                <th>Correo electrónico</th>
                <th>Tarjeta</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                    <td>@_usuario.Nombre</td>
                    <td>@_usuario.Apellido</td>
                    <th>@_usuario.FechaDeNacimiento</th>
                    <td>@_usuario.CorreoElectronico</td>
                    <td>@_numeroTarjeta</td>
            </tr>
        </tbody>
    </table>
}

<h3>Mis Reservas</h3>
@if (rol != RolUsuario.Usuario )
{
    //<p>Debes iniciar sesión para ver tus reservas.</p>
}
else if (reservas.Count == 0)
{
    <p>No tenés reservas.</p>
}
else
{
    @foreach (var reserva in reservas)
    {
        <div class="card p-2 my-2">
            <div class="d-flex justify-content-between align-items-start">
                <div> 
                    <p>Alojamiento: @reserva.IdAlojamiento</p>
                    <p>Desde: @reserva.FechaInicioEstadia.ToShortDateString()</p>
                    <p>Hasta: @reserva.FechaFinEstadia.ToShortDateString()</p>
                    <p>Monto: $@reserva.MontoEstadia</p>
                </div>
                <span class="badge bg-secondary fs-6">@reserva.EstadoReserva</span>
            </div>
            <div class="d-flex justify-content-end align-items-end mt-2" style="height: 40px;">
                @if (reserva.FechaInicioEstadia > DateTime.Now)
                {
                    <button class="btn btn-danger rounded-0 px-4 py-2" style="min-width: 80px;" @onclick="() => Cancelar(reserva.Id)">
                        Cancelar
                    </button>
                    <!-- Puntuar solo si aún no fue puntuada -->
                }
                @if(reserva.EstadoReserva == EstadoReserva.Finalizada || reserva.EstadoReserva == EstadoReserva.Confirmada || reserva.EstadoReserva == EstadoReserva.EnCurso){
                    <button class="btn btn-outline-primary position-relative me-2" @onclick="() => IrAlChat(reserva.Id)">
                        Chat
                        @if (reserva.MensajesNoLeidos > 0)
                        {
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                @reserva.MensajesNoLeidos
                            <span class="visually-hidden">mensajes no leídos</span>
                            </span>
                        }
                    </button>
                }
                @if(reserva.Puntuacion==-1){ 
                    <div>
                        @for (int i = 1; i <= 5; i++)
                        {
                            var puntuacion = i; // Captura correcta del valor
                            <button class="btn btn-link p-0"
                            style="font-size: 1.5rem; color:@((puntuaciones.ContainsKey(reserva.Id) && puntuaciones[reserva.Id] >= puntuacion) ? "gold" : "#ccc")"
                            @onclick="async () => await Puntuar(reserva.Id, puntuacion)">
                                ★
                            </button>
                        }
                    </div>
                }
                else{
                    <div>
                        @for (int i = 1; i <= 5; i++)
                        {
                            <span style="font-size: 1.5rem; color:@(i <= reserva.Puntuacion ? "gold" : "#ccc")">★</span>
                        }
                    </div>
                }
            </div>
        </div>
    }
}
@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger" role="alert">
        @((MarkupString)ErrorMessage)
    </div>
}

@if (!string.IsNullOrEmpty(SuccessMessage))
{
    <div class="alert alert-success" role="alert">
        @SuccessMessage
    </div>
}
@code {

    public RolUsuario rol => ServicioSesion.Rol;
    public int usuario_Actual => ServicioSesion.Id;
    private List<Reserva> reservas = new();
    private bool _usuarioInicializado = false;
    Usuario _usuario = new Usuario();
    String _numeroTarjeta = string.Empty;
    String ErrorMessage { get; set; } = string.Empty;
    String SuccessMessage { get; set; } = string.Empty;
   private Dictionary<int, int> puntuaciones = new(); // idReserva -> puntuación
    protected override void OnInitialized()
    {
        ServicioSesion.IniciarSesion();
        StateHasChanged();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_usuarioInicializado)
        {
            await ServicioSesion.InicializarUsuarioAsync();
            _usuarioInicializado = true;

            var usuario = UsuarioRepositorio.ObtenerPorId(ServicioSesion.Id);
            if (usuario != null)
            {
                _usuario = usuario;
                _numeroTarjeta = TarjetaRepositorio.ObtenerPorIdUltimosCuatro(usuario.TarjetaId);
            }
            reservas = ReservaConsultaTodosPorUsuario.Ejecutar(ServicioSesion.Id);
            StateHasChanged();
        }
    }

    private void Cancelar(int idReserva)
    {
        var mensaje = cancelarReservaUseCase.CancelarReserva(idReserva);
        Console.WriteLine(mensaje);
        OnInitialized();
    }
    private async Task Puntuar(int idReserva, int valor){
        if (valor < 1 || valor > 5) return;
        try{
            puntuaciones[idReserva] = valor;
            await AlojamientoPuntuar.Ejecutar(idReserva, valor);
            // Aquí puedes llamar a un método del repositorio para guardar la puntuación en la base de datos
            // Por ejemplo: ReservasRepositorio.PuntuarReserva(idReserva, valor);
            var reserva = reservas.FirstOrDefault(r => r.Id == idReserva);
            if (reserva != null)
                reserva.Puntuacion = valor;

            ErrorMessage = string.Empty;
            SuccessMessage = "¡Puntuación guardada correctamente!";
            StateHasChanged();
        }
        catch(Exception ex)
        {
            SuccessMessage = string.Empty;
            ErrorMessage = $"{ex.Message}";
        }
    }
    private void IrAlChat(int idReserva)
    {
        NavigationManager.NavigateTo($"/Chat/{idReserva}");
    }
}
